<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Tawk Secure Mode – Load-time Identity</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
</head>
<body style="font-family:system-ui,Arial;padding:2rem">
  <h1>Tawk.to – Secure Mode (visitor before load)</h1>

  <script>
    // Simulated logged-in couple
    const couple = { name: "Ali & Zara", email: "ali.zara@example.com".trim() };

    // Your deployed API endpoint that returns HMAC(email, secret) in { hash }
    const API_URL = "https://tawk-secure-demo-git-main-saimsidds-projects.vercel.app/api/tawk-hash";

    (async function init() {
      try {
        const res = await fetch(`${API_URL}?email=${encodeURIComponent(couple.email)}`);
        const { hash } = await res.json();
        if (!hash) { console.error("No hash from API"); return; }

        // 1) Set visitor identity (with hash) BEFORE loading the widget
        window.Tawk_API = window.Tawk_API || {};
        window.Tawk_API.visitor = {
          name: couple.name,
          email: couple.email,
          hash: hash
        };

        // (Optional) logs
        window.Tawk_API.onLoad = () => console.log("Tawk loaded (load-time identity)"); 

        // 2) NOW load the widget script
        var s1 = document.createElement("script");
        s1.async = true;
        s1.src = "https://embed.tawk.to/68a6124001fdb71924bc8a36/1j34bejsn";
        s1.charset = "UTF-8";
        s1.setAttribute("crossorigin", "*");
        document.head.appendChild(s1);
      } catch (e) {
        console.error("init error", e);
      }
    })();
  </script>
</body>
</html>
